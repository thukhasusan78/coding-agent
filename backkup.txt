import asyncio
from google import genai
from google.genai.types import HttpOptions, HttpRetryOptions, GenerateContentConfig
from src.core.state import AgentState
from src.core.llm import llm_engine
from config.settings import settings
from src.tools.files import file_tools

class CoderAgent:
    async def execute(self, state: AgentState):
        task = state['current_task']
        existing_code = file_tools.read_file(task['file'])
        structure = file_tools.get_project_structure()
        
        # Error á€•á€«á€”á€±á€›á€„á€º á€¡á€á€…á€ºá€€á€•á€¼á€”á€ºá€›á€±á€¸á€–á€­á€¯á€· Code á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€œá€­á€¯á€€á€ºá€™á€šá€º
        if "Error" in existing_code: existing_code = ""

        print(f"âš¡ Coder ({settings.MODEL_CODER_NAME}): Started coding {task['file']}...")

        prompt = f"""
        You are a Senior Python Developer.
        Task: {task['description']}
        File: {task['file']}
        Context: {structure}
        Current Code: {existing_code}
        Errors: {state.get('error_logs', 'None')}
        Requirement: Write the COMPLETE code inside ```python ... ``` (or relevant language) block.
        """
        
        code = ""
        
        # ğŸ”¥ Retry Logic with Key Rotation
        for attempt in range(settings.MAX_RETRIES):
            try:
                current_key = llm_engine.key_manager.get_next_key()

                # 2. SDK á€›á€²á€· Internal Retry á€€á€­á€¯á€•á€­á€á€ºá€–á€­á€¯á€· Client á€¡á€á€…á€º á€á€á€†á€±á€¬á€€á€ºá€™á€šá€º
                # (Key Manager Logic á€™á€•á€»á€€á€ºá€…á€±á€˜á€² Config á€•á€¼á€„á€ºá€á€²á€·á€”á€Šá€ºá€¸)
                safe_client = genai.Client(
                    api_key=current_key,
                    http_options=HttpOptions(
                        retry_options=HttpRetryOptions(attempts=1) # âš ï¸ SDK á€€á€­á€¯ á€™á€…á€±á€¬á€„á€·á€ºá€á€­á€¯á€„á€ºá€¸á€á€±á€¬á€·á€˜á€°á€¸
                    )
                )

                # 3. AFC (Tools) á€€á€­á€¯á€•á€­á€á€ºá€•á€¼á€®á€¸ Code á€›á€±á€¸á€á€­á€¯á€„á€ºá€¸á€™á€šá€º
                config = GenerateContentConfig(
                    temperature=0.2,
                    tools=None, # âš ï¸ Loop á€™á€•á€á€ºá€¡á€±á€¬á€„á€º Tool á€œá€¯á€¶á€¸á€á€•á€­á€á€ºá€‘á€¬á€¸á€™á€šá€º
                    system_instruction="You are a coding engine. Output only code. Do not use tools."
                )

                # 4. Native Async Call (Thread á€™á€Ÿá€¯á€á€ºá€á€±á€¬á€·á€œá€­á€¯á€· á€•á€±á€«á€·á€•á€«á€¸á€á€½á€¬á€¸á€™á€šá€º)
                response = await safe_client.aio.models.generate_content(
                    model=settings.MODEL_CODER_NAME,
                    contents=prompt,
                    config=config
                )
                
                code = response.text
                print(f"âœ… Coder: Code generated successfully using Key ending in ...{current_key[-4:]}")
                break 

            except Exception as e:
                error_msg = str(e)
                print(f"âš ï¸ Attempt {attempt+1} Failed: {error_msg}")
                
                # 503 (Overload) á€–á€¼á€…á€ºá€›á€„á€º Model á€•á€¼á€±á€¬á€„á€ºá€¸á€™á€œá€¬á€¸áŠ á€…á€±á€¬á€„á€·á€ºá€™á€œá€¬á€¸
                if "503" in error_msg or "429" in error_msg:
                    # á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€¡á€€á€¼á€­á€™á€ºá€›á€±á€¬á€€á€ºá€›á€„á€º Backup Model (Flash 2.5) á€”á€²á€· á€…á€™á€ºá€¸á€™á€šá€º
                    if attempt == settings.MAX_RETRIES - 1:
                        print("âŒ 3 Flash Preview overloaded. Switching to 2.0 Flash as backup...")
                        try:
                            # Backup call
                            backup_resp = await safe_client.aio.models.generate_content(
                                model="gemini-2.5-flash", 
                                contents=prompt,
                                config=config
                            )
                            code = backup_resp.text
                            break
                        except:
                            pass
                
                # Exponential Backoff (1s, 2s, 4s)
                await asyncio.sleep(2 ** attempt)

        # --- Code Parsing Logic (Original Feature) ---
        if code and "```" in code:
            parts = code.split("```")
            if len(parts) > 1:
                code = parts[1]
                # Language identifier á€á€½á€±á€€á€­á€¯ á€–á€šá€ºá€‘á€¯á€á€ºá€™á€šá€º
                if code.startswith("python"): code = code[6:]
                elif code.startswith("html"): code = code[4:]
                elif code.startswith("css"): code = code[3:]
                elif code.startswith("javascript"): code = code[10:]
                elif code.startswith("js"): code = code[2:]
                code = code.strip()
            
        return {"code_content": code}